<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset='utf-8'>
    <title>Fresco | Modifying the Image</title>
    <link rel='stylesheet' href='/static/site.css' type='text/css'/>
    <link rel="stylesheet" href='/static/pygments.css' type='text/css'/>
    <link rel='shortcut icon' href='/static/favicon.png'>
    <meta name='viewport' content='width=480'>
    <meta property="og:title" content="Modifying the Image" />
    <meta property="og:site_name" content="fresco">
    <meta property='og:description' content='Fresco is an image management library.'>
    <meta property='og:image' content='http://facebook.github.io/fresco/static/fresco-og-image.png'>
    <meta property='og:url' content="http://facebook.github.io/fresco/docs/modifying-image.html">
    
    <meta property='og:type' content='website'>
    
    <script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script>
    <script type="text/javascript">{'try{Typekit.load();}catch(e){}'}</script>
    <!-- Google Analytics -->
</head>
<body>

<header class='topbar'><nav class='width'>
<a href='/'>
  <img src="/static/fresco-logo.png" class="logo">
</a>
    <ul>
      <li><a href="/docs/index.html#_"
          
          class="active" >
          Docs
      </a></li>
      <li><a href="/"
          >
          About
      </a></li>
      <li><a href="/support.html"
          >
          Support
      </a></li>
      <li><a href="/javadoc">
          API
      </a></li>
      <li><a href="http://github.com/facebook/fresco">GitHub</a></li>
      <li><a href="http://fresco-cn.org">中文版</a></li>
      <li><a href="http://fresco.recrack.com">한국어</a></li>
    </ul>
</nav></header>


<section class='content'><div class='width'>

<nav class='toc'>
  
    <section>
      <h3>Quick Start</h3>
      <ul>
        
          <li>
            <a href="/docs/index.html#_">
              Adding Fresco to your Project
            </a>
            
          </li>
        
          <li>
            <a href="/docs/getting-started.html#_">
              Getting started with Fresco
            </a>
            
          </li>
        
          <li>
            <a href="/docs/concepts.html#_">
              Concepts
            </a>
            
          </li>
        
          <li>
            <a href="/docs/supported-uris.html#_">
              Supported URIs
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Drawee Guide</h3>
      <ul>
        
          <li>
            <a href="/docs/using-drawees-xml.html#_">
              Using Drawees in XML
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-drawees-code.html#_">
              Using Drawees in Code
            </a>
            
          </li>
        
          <li>
            <a href="/docs/drawee-components.html#_">
              Drawee Components
            </a>
            
          </li>
        
          <li>
            <a href="/docs/progress-bars.html#_">
              Progress Bars
            </a>
            
          </li>
        
          <li>
            <a href="/docs/scaling.html#_">
              Scaling
            </a>
            
          </li>
        
          <li>
            <a href="/docs/rounded-corners-and-circles.html#_">
              Rounded Corners and Circles
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-controllerbuilder.html#_">
              Using the ControllerBuilder
            </a>
            
          </li>
        
          <li>
            <a href="/docs/progressive-jpegs.html#_">
              Progressive JPEGs
            </a>
            
          </li>
        
          <li>
            <a href="/docs/animations.html#_">
              Animated Images
            </a>
            
          </li>
        
          <li>
            <a href="/docs/requesting-multiple-images.html#_">
              Requesting Multiple Images
            </a>
            
          </li>
        
          <li>
            <a href="/docs/listening-download-events.html#_">
              Listening to Download Events
            </a>
            
          </li>
        
          <li>
            <a href="/docs/resizing-rotating.html#_">
              Resizing and Rotating
            </a>
            
          </li>
        
          <li>
            <a href="/docs/modifying-image.html#_" class="active">
              Modifying the Image
            </a>
            
          </li>
        
          <li>
            <a href="/docs/image-requests.html#_">
              Image Requests
            </a>
            
          </li>
        
          <li>
            <a href="/docs/writing-custom-views.html#_">
              Writing Custom Views
            </a>
            
          </li>
        
          <li>
            <a href="/docs/gotchas.html#_">
              Gotchas
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Image Pipeline Guide</h3>
      <ul>
        
          <li>
            <a href="/docs/intro-image-pipeline.html#_">
              Introduction to the Image Pipeline
            </a>
            
          </li>
        
          <li>
            <a href="/docs/configure-image-pipeline.html#_">
              Configuring the Image Pipeline
            </a>
            
          </li>
        
          <li>
            <a href="/docs/caching.html#_">
              Cache Behavior
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-image-pipeline.html#_">
              Using the Image Pipeline Directly
            </a>
            
          </li>
        
          <li>
            <a href="/docs/datasources-datasubscribers.html#_">
              DataSources and DataSubscribers
            </a>
            
          </li>
        
          <li>
            <a href="/docs/closeable-references.html#_">
              Closeable References
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Third Party Libraries</h3>
      <ul>
        
          <li>
            <a href="/docs/using-other-network-layers.html#_">
              Using Other Network Layers
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-other-image-loaders.html#_">
              Using Other Image Loaders
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Contributing to Fresco</h3>
      <ul>
        
          <li>
            <a href="/docs/building-from-source.html#_">
              Building from Source
            </a>
            
          </li>
        
      </ul>
    </section>
  
</nav>


<article class='withtoc'>
    <h1>
      Modifying the Image
      <a class="edit-page-link" href="https://github.com/facebook/fresco/tree/gh-pages/docs/01-modifying-image.md" target="_blank">Edit on GitHub</a>
    </h1>
    <p></p>

    <h4>Motivation</h4>

<p>Sometimes the image downloaded from the server, or fetched from local storage, is not exactly what you want to display on the screen. If you want to apply custom code to the image in-place, use a Postprocessor. The best way to do this is to subclass <a href="../javadoc/reference/com/facebook/imagepipeline/request/BasePostprocessor.html">BasePostprocessor</a>.</p>

<h4>Example</h4>

<p>The following example applies a red mesh to the image:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Uri</span> <span class="n">uri</span><span class="o">;</span>
<span class="n">Postprocessor</span> <span class="n">redMeshPostprocessor</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BasePostprocessor</span><span class="o">()</span> <span class="o">{</span> 
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;redMeshPostprocessor&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span> <span class="n">x</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span> <span class="n">y</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bitmap</span><span class="o">.</span><span class="na">setPixel</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">RED</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">ImageRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">ImageRequestBuilder</span><span class="o">.</span><span class="na">newBuilderWithSource</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setPostprocessor</span><span class="o">(</span><span class="n">redMeshPostprocessor</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="n">PipelineDraweeController</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">Fresco</span><span class="o">.</span><span class="na">newDraweeControllerBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setImageRequest</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setOldController</span><span class="o">(</span><span class="n">mSimpleDraweeView</span><span class="o">.</span><span class="na">getOldController</span><span class="o">())</span>
    <span class="c1">// other setters as you need</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">mSimpleDraweeView</span><span class="o">.</span><span class="na">setController</span><span class="o">(</span><span class="n">controller</span><span class="o">);</span>
</code></pre></div>
<h4>Things to Know</h4>

<p>The image is copied before it enters your postprocessor. The copy of the image in cache is <em>not</em> affected by any changes you make in your postprocessor. On Android 4.x and lower, the copy is stored outside the Java heap, just as the original image was.</p>

<p>If you show the same image repeatedly, you must specify the postprocessor each time it is requested. You are free to use different postprocessors on different requests for the same image.</p>

<p>Postprocessors are not currently supported for <a href="animations.html">animated</a> images.</p>

<h4>Copying the bitmap</h4>

<p>There may be cases where an in-place post-process is not possible. If that is the case, <code>BasePostprocessor</code> has a second <code>process</code> method that takes two arguments. This example horizontally flips the bitmap:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">destBitmap</span><span class="o">,</span> <span class="n">Bitmap</span> <span class="n">sourceBitmap</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">destBitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">destBitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span> <span class="n">y</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">destBitmap</span><span class="o">.</span><span class="na">setPixel</span><span class="o">(</span><span class="n">destBitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">sourceBitmap</span><span class="o">.</span><span class="na">getPixel</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The destination and source bitmaps are the same size. </p>

<ul>
<li>Do <strong>not</strong> modify the source Bitmap. In future releases this will throw an exception.</li>
<li>Do <strong>not</strong> keep a reference to either bitmap. Both have their memory managed by the image pipeline. The destBitmap will end up in your Drawee or DataSource normally.</li>
</ul>

<h4>Copying into a different size</h4>

<p>If the postprocessed image needs to be a different size from the original, we have a third <code>process</code> method. Here, you can make use of our <a href="../javadoc/reference/com/facebook/imagepipeline/bitmaps/PlatformBitmapFactory.html">PlatformBitmapFactory</a> class to safely create a bitmap, of a size you specify, off the Java heap.</p>

<p>This example samples every other pixel into a quarter-size bitmap:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span> <span class="nf">process</span><span class="o">(</span>
    <span class="n">Bitmap</span> <span class="n">sourceBitmap</span><span class="o">,</span>
    <span class="n">PlatformBitmapFactory</span> <span class="n">bitmapFactory</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span> <span class="n">bitmapRef</span> <span class="o">=</span> <span class="n">bitmapFactory</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span>
      <span class="n">sourceBitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span><span class="o">,</span>
      <span class="n">sourceBitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">Bitmap</span> <span class="n">destBitmap</span> <span class="o">=</span> <span class="n">bitmapRef</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">destBitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span> <span class="n">x</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">destBitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span> <span class="n">y</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">destBitmap</span><span class="o">.</span><span class="na">setPixel</span><span class="o">(</span><span class="n">sourceBitmap</span><span class="o">.</span><span class="na">getPixel</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">));</span>
       <span class="o">}</span>
     <span class="o">}</span>
     <span class="k">return</span> <span class="n">CloseableReference</span><span class="o">.</span><span class="na">cloneOrNull</span><span class="o">(</span><span class="n">bitmapRef</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">CloseableReference</span><span class="o">.</span><span class="na">closeSafely</span><span class="o">(</span><span class="n">bitmapRef</span><span class="o">);</span>
  <span class="o">}</span> 
<span class="o">}</span>
</code></pre></div>
<p>You must follow the rules for <a href="closeable-references.html">closeable references</a>.</p>

<p>Do <strong>not</strong> use the Android <code>Bitmap.createBitmap</code> method, which creates a bitmap on the Java heap.</p>

<h4>Which to override?</h4>

<p>Do not override more than one of the three <code>process</code> methods. Doing so can produce unpredictable results.</p>

<h4>Repeated Postprocessors</h4>

<p>What if you want to post-process the same image more than once? No problem at all. Just subclass <a href="../javadoc/reference/com/facebook/imagepipeline/request/BaseRepeatedPostProcessor.html">BaseRepeatedPostprocessor</a>. This class has an <code>update</code> method which can be invoked at any time to run the postprocessor again.</p>

<p>The example below allows you to change the color of the mesh at any time.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MeshPostprocessor</span> <span class="kd">extends</span> <span class="n">BaseRepeatedPostprocessor</span> <span class="o">{</span> 
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">mColor</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">TRANSPARENT</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mColor</span> <span class="o">=</span> <span class="n">color</span><span class="o">;</span>
    <span class="n">update</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;meshPostprocessor&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span> <span class="n">x</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span> <span class="n">y</span><span class="o">+=</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bitmap</span><span class="o">.</span><span class="na">setPixel</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">mColor</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="n">MeshPostprocessor</span> <span class="n">meshPostprocessor</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MeshPostprocessor</span><span class="o">();</span>

<span class="c1">/// setPostprocessor as in above example</span>

<span class="n">meshPostprocessor</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">RED</span><span class="o">);</span>
<span class="n">meshPostprocessor</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>
</code></pre></div>
<p>You should have still have one <code>Postprocessor</code> instance per image request, as internally the class is stateful.</p>


    <div class="docs-prevnext">
      
        <a href="/docs/resizing-rotating.html#_">&larr; Prev</a>
      
      
        <a class="right" href="/docs/image-requests.html#_">Next &rarr;</a>
      
    </div>

    <a id="_"></a>
</article>

</div></section>
<footer><div class='width'>
    &copy; Copyright 2015, Facebook Inc.<br>
    Documentation licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Sample code licensed under the <a href="/sample-license.html">sample license</a>.
</div></footer>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
  ga('create', 'UA-44373548-3', 'auto');
  ga('send', 'pageview');
 
</script>
<script src="/static/linkify.js"></script>
</body>
</html>


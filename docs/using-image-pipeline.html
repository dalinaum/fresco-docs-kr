<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset='utf-8'>
    <title>Fresco | Using the Image Pipeline Directly</title>
    <link rel='stylesheet' href='/static/site.css' type='text/css'/>
    <link rel="stylesheet" href='/static/pygments.css' type='text/css'/>
    <link rel='shortcut icon' href='/static/favicon.png'>
    <meta name='viewport' content='width=480'>
    <meta property="og:title" content="Using the Image Pipeline Directly" />
    <meta property="og:site_name" content="fresco">
    <meta property='og:description' content='Fresco is an image management library.'>
    <meta property='og:image' content='http://facebook.github.io/fresco/static/fresco-og-image.png'>
    <meta property='og:url' content="http://facebook.github.io/fresco/docs/using-image-pipeline.html">
    
    <meta property='og:type' content='website'>
    
    <script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script>
    <script type="text/javascript">{'try{Typekit.load();}catch(e){}'}</script>
    <!-- Google Analytics -->
</head>
<body>

<header class='topbar'><nav class='width'>
<a href='/'>
  <img src="/static/fresco-logo.png" class="logo">
</a>
    <ul>
      <li><a href="/docs/index.html#_"
          
          class="active" >
          Docs
      </a></li>
      <li><a href="/"
          >
          About
      </a></li>
      <li><a href="/support.html"
          >
          Support
      </a></li>
      <li><a href="/javadoc">
          API
      </a></li>
      <li><a href="http://github.com/facebook/fresco">GitHub</a></li>
      <li><a href="http://fresco-cn.org">中文版</a></li>
      <li><a href="http://fresco.recrack.com">한국어</a></li>
    </ul>
</nav></header>


<section class='content'><div class='width'>

<nav class='toc'>
  
    <section>
      <h3>Quick Start</h3>
      <ul>
        
          <li>
            <a href="/docs/index.html#_">
              Adding Fresco to your Project
            </a>
            
          </li>
        
          <li>
            <a href="/docs/getting-started.html#_">
              Getting started with Fresco
            </a>
            
          </li>
        
          <li>
            <a href="/docs/concepts.html#_">
              Concepts
            </a>
            
          </li>
        
          <li>
            <a href="/docs/supported-uris.html#_">
              Supported URIs
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Drawee Guide</h3>
      <ul>
        
          <li>
            <a href="/docs/using-drawees-xml.html#_">
              Using Drawees in XML
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-drawees-code.html#_">
              Using Drawees in Code
            </a>
            
          </li>
        
          <li>
            <a href="/docs/drawee-components.html#_">
              Drawee Components
            </a>
            
          </li>
        
          <li>
            <a href="/docs/progress-bars.html#_">
              Progress Bars
            </a>
            
          </li>
        
          <li>
            <a href="/docs/scaling.html#_">
              Scaling
            </a>
            
          </li>
        
          <li>
            <a href="/docs/rounded-corners-and-circles.html#_">
              Rounded Corners and Circles
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-controllerbuilder.html#_">
              Using the ControllerBuilder
            </a>
            
          </li>
        
          <li>
            <a href="/docs/progressive-jpegs.html#_">
              Progressive JPEGs
            </a>
            
          </li>
        
          <li>
            <a href="/docs/animations.html#_">
              Animated Images
            </a>
            
          </li>
        
          <li>
            <a href="/docs/requesting-multiple-images.html#_">
              Requesting Multiple Images
            </a>
            
          </li>
        
          <li>
            <a href="/docs/listening-download-events.html#_">
              Listening to Download Events
            </a>
            
          </li>
        
          <li>
            <a href="/docs/resizing-rotating.html#_">
              Resizing and Rotating
            </a>
            
          </li>
        
          <li>
            <a href="/docs/modifying-image.html#_">
              Modifying the Image
            </a>
            
          </li>
        
          <li>
            <a href="/docs/image-requests.html#_">
              Image Requests
            </a>
            
          </li>
        
          <li>
            <a href="/docs/writing-custom-views.html#_">
              Writing Custom Views
            </a>
            
          </li>
        
          <li>
            <a href="/docs/gotchas.html#_">
              Gotchas
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Image Pipeline Guide</h3>
      <ul>
        
          <li>
            <a href="/docs/intro-image-pipeline.html#_">
              Introduction to the Image Pipeline
            </a>
            
          </li>
        
          <li>
            <a href="/docs/configure-image-pipeline.html#_">
              Configuring the Image Pipeline
            </a>
            
          </li>
        
          <li>
            <a href="/docs/caching.html#_">
              Cache Behavior
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-image-pipeline.html#_" class="active">
              Using the Image Pipeline Directly
            </a>
            
          </li>
        
          <li>
            <a href="/docs/datasources-datasubscribers.html#_">
              DataSources and DataSubscribers
            </a>
            
          </li>
        
          <li>
            <a href="/docs/closeable-references.html#_">
              Closeable References
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Third Party Libraries</h3>
      <ul>
        
          <li>
            <a href="/docs/using-other-network-layers.html#_">
              Using Other Network Layers
            </a>
            
          </li>
        
          <li>
            <a href="/docs/using-other-image-loaders.html#_">
              Using Other Image Loaders
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Contributing to Fresco</h3>
      <ul>
        
          <li>
            <a href="/docs/building-from-source.html#_">
              Building from Source
            </a>
            
          </li>
        
      </ul>
    </section>
  
</nav>


<article class='withtoc'>
    <h1>
      Using the Image Pipeline Directly
      <a class="edit-page-link" href="https://github.com/facebook/fresco/tree/gh-pages/docs/02-using-image-pipeline.md" target="_blank">Edit on GitHub</a>
    </h1>
    <p></p>

    <p>This page is intended for advanced usage only. Most apps should be using <a href="using-drawees-xml.html">Drawees</a> to interact with Fresco&#39;s image pipeline.</p>

<p>Using the image pipeline directly is challenging because of the memory usage. Drawees automatically keep track of whether or not your images need to be in memory. They will swap them out and load them back as soon as they need to be displayed. If you are using the image pipeline directly, your app must repeat this logic.</p>

<p>The image pipeline returns objects wrapped in a <a href="closeable-references.html">CloseableReference</a>. Drawees call the <code>.close()</code> method on these objects when they are finished with them. If your app is not using Drawees, it must do the same.</p>

<p>The Java garbage collector will free image memory when Bitmap objects go out of scope, but this may be too late. Garbage collection is expensive, and relying on it for large objects leads to performance issues. This is especially true on Android 4.x and lower, when Android did not maintain a separate memory space for Bitmaps.</p>

<h4>Calling the pipeline</h4>

<p>You must <a href="image-requests.html">build an image request</a>. Having done that, you can pass it directly to the <code>ImagePipeline:</code></p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ImagePipeline</span> <span class="n">imagePipeline</span> <span class="o">=</span> <span class="n">Fresco</span><span class="o">.</span><span class="na">getImagePipeline</span><span class="o">();</span>
<span class="n">DataSource</span><span class="o">&lt;</span><span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">CloseableImage</span><span class="o">&gt;&gt;</span> 
    <span class="n">dataSource</span> <span class="o">=</span> <span class="n">imagePipeline</span><span class="o">.</span><span class="na">fetchDecodedImage</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">);</span>
</code></pre></div>
<p>See the page on <a href="datasources-datasubscribers.html">DataSources</a> for information on how to receive data from them.</p>

<h4>Skipping the decode</h4>

<p>If you don&#39;t want to decode the image, but want to keep it in its original compressed format, just use <code>fetchEncodedImage</code> instead:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">PooledByteBuffer</span><span class="o">&gt;&gt;</span> 
    <span class="n">dataSource</span> <span class="o">=</span> <span class="n">imagePipeline</span><span class="o">.</span><span class="na">fetchEncodedImage</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">);</span>
</code></pre></div>
<h4>Instant results from the bitmap cache</h4>

<p>Lookups to the bitmap cache, unlike the others, are done in the UI thread. If a Bitmap is there, you get it instantly. </p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">CloseableImage</span><span class="o">&gt;&gt;</span> <span class="n">dataSource</span> <span class="o">=</span>
    <span class="n">imagePipeline</span><span class="o">.</span><span class="na">fetchImageFromBitmapCache</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">CloseableImage</span><span class="o">&gt;</span> <span class="n">imageReference</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getResult</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">imageReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">CloseableImage</span> <span class="n">image</span> <span class="o">=</span> <span class="n">imageReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
      <span class="c1">// do something with the image</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">CloseableReference</span><span class="o">.</span><span class="na">closeSafely</span><span class="o">(</span><span class="n">imageReference</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="n">dataSource</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>
<p>Do <strong>not</strong> skip this <code>finally</code> blocks!</p>

<h4>Prefetching</h4>

<p>Prefetching images in advance of showing them can sometimes lead to shorter wait times for users. Remember, however, that there are trade-offs. Prefetching takes up your users&#39; data, and uses up its share of CPU and memory. As a rule, prefetching is not recommended for most apps.</p>

<p>Nonetheless, the image pipeline allows you to prefetch to either disk or bitmap cache. Both will use more data for network URIs, but the disk cache will not do a decode and will therefore use less CPU.</p>

<p>Prefetch to disk:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">imagePipeline</span><span class="o">.</span><span class="na">prefetchToDiskCache</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">);</span>
</code></pre></div>
<p>Prefetch to bitmap cache:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">imagePipeline</span><span class="o">.</span><span class="na">prefetchToBitmapCache</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">);</span>
</code></pre></div>

    <div class="docs-prevnext">
      
        <a href="/docs/caching.html#_">&larr; Prev</a>
      
      
        <a class="right" href="/docs/datasources-datasubscribers.html#_">Next &rarr;</a>
      
    </div>

    <a id="_"></a>
</article>

</div></section>
<footer><div class='width'>
    &copy; Copyright 2015, Facebook Inc.<br>
    Documentation licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Sample code licensed under the <a href="/sample-license.html">sample license</a>.
</div></footer>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
  ga('create', 'UA-44373548-3', 'auto');
  ga('send', 'pageview');
 
</script>
<script src="/static/linkify.js"></script>
</body>
</html>

